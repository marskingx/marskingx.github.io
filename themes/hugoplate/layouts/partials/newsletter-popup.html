<!-- ç¾ä»£åŒ–é›»å­å ±è¨‚é–±å½ˆçª— -->
<div id="newsletter-popup-overlay" class="fixed inset-0 z-50 flex items-center justify-center p-4 opacity-0 pointer-events-none transition-all duration-500 ease-out">
  <!-- èƒŒæ™¯é®ç½© -->
  <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
  
  <!-- å½ˆçª—å®¹å™¨ -->
  <div id="newsletter-popup-modal" class="relative bg-white dark:bg-gray-800 max-w-lg w-full rounded-2xl shadow-2xl transform scale-90 transition-all duration-500 ease-out">
    <!-- é—œé–‰æŒ‰éˆ• -->
    <button id="newsletter-popup-close" 
            class="absolute -top-3 -right-3 w-8 h-8 bg-gray-600 hover:bg-gray-700 text-white rounded-full flex items-center justify-center transition-all duration-300 hover:scale-110 z-10">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>

    <!-- é ‚éƒ¨è£é£¾å€åŸŸ -->
    <div class="bg-gradient-to-r from-blue-600 via-purple-600 to-indigo-600 rounded-t-2xl p-6 text-white">
      <!-- åœ–ç¤º -->
      <div class="flex justify-center mb-4">
        <div class="w-16 h-16 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 7.89a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
          </svg>
        </div>
      </div>
      
      <!-- æ¨™é¡Œ -->
      <h2 class="text-2xl font-bold text-center mb-2">ğŸ’° åŠ å…¥æ‡¶å¾—è®Šæœ‰éŒ¢</h2>
      <p class="text-center text-blue-100 text-sm">æ¯é€±ç²å¾—æœ€æ–°ç†è²¡å¿ƒæ³•èˆ‡æŠ•è³‡æ´å¯Ÿ</p>
    </div>

    <!-- å…§å®¹å€åŸŸ -->
    <div class="p-6">
      <!-- åƒ¹å€¼ä¸»å¼µ -->
      <div class="mb-6">
        <div class="grid grid-cols-1 gap-3">
          <div class="flex items-center text-gray-700 dark:text-gray-300">
            <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
              <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <span class="text-sm">æ¯é€±ç²¾é¸ç†è²¡æ–‡ç« èˆ‡å¸‚å ´åˆ†æ</span>
          </div>
          
          <div class="flex items-center text-gray-700 dark:text-gray-300">
            <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
              <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <span class="text-sm">ç¨å®¶æŠ•è³‡ç­–ç•¥èˆ‡å¯¦æˆ°ç¶“é©—åˆ†äº«</span>
          </div>
          
          <div class="flex items-center text-gray-700 dark:text-gray-300">
            <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center mr-3 flex-shrink-0">
              <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            </div>
            <span class="text-sm">ä¸å®šæœŸè´ˆé€å¯¦ç”¨ç†è²¡å·¥å…·èˆ‡è³‡æº</span>
          </div>
        </div>
      </div>

      <!-- è¨‚é–±è¡¨å–® -->
      <form id="newsletter-form" action="{{ site.Params.subscription.mailchimp_form_action }}" method="POST" target="_blank" class="space-y-4">
        <div class="relative">
          <input 
            type="email" 
            name="EMAIL" 
            id="newsletter-email"
            placeholder="è¼¸å…¥æ‚¨çš„ Email åœ°å€" 
            required
            class="w-full px-4 py-3 pr-12 border-2 border-gray-300 dark:border-gray-600 rounded-xl bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-500/20 transition-all duration-300 outline-none" 
          />
          <div class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
            </svg>
          </div>
        </div>

        <!-- éš±è—å­—æ®µ -->
        <div style="position: absolute; left: -5000px;">
          <input type="text" name="{{ site.Params.subscription.mailchimp_form_name }}" tabindex="-1" value="">
        </div>

        <button 
          type="submit"
          class="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-xl transition-all duration-300 transform hover:scale-[1.02] hover:shadow-lg focus:ring-4 focus:ring-blue-500/20 focus:outline-none"
        >
          <span class="flex items-center justify-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            ç«‹å³å…è²»è¨‚é–±
          </span>
        </button>
      </form>

      <!-- åº•éƒ¨èªªæ˜ -->
      <div class="mt-4 text-center">
        <p class="text-xs text-gray-500 dark:text-gray-400">
          æˆ‘å€‘å°Šé‡æ‚¨çš„éš±ç§ï¼Œéš¨æ™‚å¯ä»¥å–æ¶ˆè¨‚é–±
        </p>
      </div>
    </div>

    <!-- åº•éƒ¨å°æ¨™èª -->
    <div class="bg-gray-50 dark:bg-gray-700 rounded-b-2xl px-6 py-3">
      <p class="text-center text-xs text-gray-600 dark:text-gray-300">
        ğŸš€ å·²æœ‰ <span class="font-semibold text-blue-600 dark:text-blue-400">5,000+</span> è®€è€…åŠ å…¥ç†è²¡æˆé•·ä¹‹è·¯
      </p>
    </div>
  </div>
</div>

<!-- CSS æ¨£å¼ -->
<style>
  @keyframes slideInScale {
    from {
      opacity: 0;
      transform: translateY(-50px) scale(0.9);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  @keyframes slideOutScale {
    from {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
    to {
      opacity: 0;
      transform: translateY(-50px) scale(0.9);
    }
  }
  
  .newsletter-popup-show {
    opacity: 1 !important;
    pointer-events: auto !important;
  }
  
  .newsletter-popup-show #newsletter-popup-modal {
    transform: scale(1) !important;
  }
  
  .newsletter-popup-hide {
    animation: slideOutScale 0.3s ease-in-out forwards;
  }
  
  #newsletter-popup-modal {
    animation: slideInScale 0.5s ease-out;
  }
  
  /* ç§»å‹•è£ç½®å„ªåŒ– */
  @media (max-width: 640px) {
    #newsletter-popup-modal {
      max-width: 90vw;
      margin: 0 20px;
    }
  }
  
  /* æ·±è‰²æ¨¡å¼ä¸‹çš„æ¼¸å±¤èª¿æ•´ */
  @media (prefers-color-scheme: dark) {
    .dark #newsletter-popup-modal {
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
  }
</style>

<!-- JavaScript åŠŸèƒ½ -->
<script>
(function() {
  'use strict';
  
  const STORAGE_KEY = 'newsletter_popup_data';
  const SHOW_DELAY = 5000; // 5ç§’å¾Œé¡¯ç¤º
  const SCROLL_THRESHOLD = 50; // æ»¾å‹•50%å¾Œå¯è§¸ç™¼
  const MAX_SHOW_COUNT = 3; // æœ€å¤šé¡¯ç¤º3æ¬¡
  const COOLDOWN_DAYS = 7; // å†·å»æœŸ7å¤©
  
  let popupData = {
    showCount: 0,
    lastShown: null,
    dismissed: false,
    subscribed: false
  };
  
  // è¼‰å…¥æœ¬åœ°å„²å­˜æ•¸æ“š
  function loadPopupData() {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        popupData = { ...popupData, ...JSON.parse(stored) };
      }
    } catch (e) {
      console.warn('Failed to load popup data:', e);
    }
  }
  
  // å„²å­˜æ•¸æ“š
  function savePopupData() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(popupData));
    } catch (e) {
      console.warn('Failed to save popup data:', e);
    }
  }
  
  // æª¢æŸ¥æ˜¯å¦æ‡‰è©²é¡¯ç¤ºå½ˆçª—
  function shouldShowPopup() {
    const now = Date.now();
    const lastShown = popupData.lastShown ? new Date(popupData.lastShown).getTime() : 0;
    const daysSinceLastShown = (now - lastShown) / (1000 * 60 * 60 * 24);
    
    return !popupData.subscribed && 
           !popupData.dismissed && 
           popupData.showCount < MAX_SHOW_COUNT &&
           daysSinceLastShown >= COOLDOWN_DAYS;
  }
  
  // é¡¯ç¤ºå½ˆçª—
  function showPopup() {
    if (!shouldShowPopup()) return;
    
    const overlay = document.getElementById('newsletter-popup-overlay');
    if (!overlay) return;
    
    overlay.classList.add('newsletter-popup-show');
    document.body.style.overflow = 'hidden';
    
    // æ›´æ–°çµ±è¨ˆ
    popupData.showCount++;
    popupData.lastShown = new Date().toISOString();
    savePopupData();
    
    // Google Analytics äº‹ä»¶è¿½è¹¤
    if (typeof gtag !== 'undefined') {
      gtag('event', 'newsletter_popup_shown', {
        event_category: 'engagement',
        event_label: 'popup_display'
      });
    }
  }
  
  // éš±è—å½ˆçª—
  function hidePopup() {
    const overlay = document.getElementById('newsletter-popup-overlay');
    if (!overlay) return;
    
    overlay.classList.add('newsletter-popup-hide');
    document.body.style.overflow = '';
    
    setTimeout(() => {
      overlay.classList.remove('newsletter-popup-show', 'newsletter-popup-hide');
    }, 300);
  }
  
  // é—œé–‰å½ˆçª—ï¼ˆä½¿ç”¨è€…ä¸»å‹•é—œé–‰ï¼‰
  function dismissPopup() {
    hidePopup();
    popupData.dismissed = true;
    savePopupData();
    
    if (typeof gtag !== 'undefined') {
      gtag('event', 'newsletter_popup_dismissed', {
        event_category: 'engagement',
        event_label: 'popup_close'
      });
    }
  }
  
  // æ»¾å‹•è§¸ç™¼æª¢æ¸¬
  let hasScrolledEnough = false;
  function checkScrollTrigger() {
    if (hasScrolledEnough) return;
    
    const scrollPercent = (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100;
    
    if (scrollPercent >= SCROLL_THRESHOLD) {
      hasScrolledEnough = true;
      setTimeout(showPopup, 1000); // å»¶é²1ç§’é¡¯ç¤º
    }
  }
  
  // é€€å‡ºæ„åœ–æª¢æ¸¬
  let exitIntentDetected = false;
  function detectExitIntent(e) {
    if (exitIntentDetected || e.clientY > 0) return;
    
    exitIntentDetected = true;
    showPopup();
    
    // ç§»é™¤äº‹ä»¶ç›£è½å™¨é¿å…é‡è¤‡è§¸ç™¼
    document.removeEventListener('mouseout', detectExitIntent);
  }
  
  // è¡¨å–®æäº¤è™•ç†
  function handleFormSubmit(e) {
    const emailInput = document.getElementById('newsletter-email');
    const email = emailInput ? emailInput.value : '';
    
    if (email) {
      popupData.subscribed = true;
      savePopupData();
      
      // Google Analytics äº‹ä»¶è¿½è¹¤
      if (typeof gtag !== 'undefined') {
        gtag('event', 'newsletter_subscribe', {
          event_category: 'conversion',
          event_label: 'popup_form',
          value: 1
        });
      }
      
      // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
      setTimeout(() => {
        hidePopup();
        // å¯ä»¥åœ¨é€™è£¡é¡¯ç¤ºæ„Ÿè¬è¨Šæ¯
      }, 500);
    }
  }
  
  // åˆå§‹åŒ–
  function init() {
    loadPopupData();
    
    // äº‹ä»¶ç›£è½å™¨
    const closeBtn = document.getElementById('newsletter-popup-close');
    const overlay = document.getElementById('newsletter-popup-overlay');
    const form = document.getElementById('newsletter-form');
    
    if (closeBtn) {
      closeBtn.addEventListener('click', dismissPopup);
    }
    
    if (overlay) {
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          dismissPopup();
        }
      });
    }
    
    if (form) {
      form.addEventListener('submit', handleFormSubmit);
    }
    
    // ESC éµé—œé–‰
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        dismissPopup();
      }
    });
    
    // è¨­å®šè§¸ç™¼æ¢ä»¶
    if (shouldShowPopup()) {
      // æ™‚é–“è§¸ç™¼
      setTimeout(showPopup, SHOW_DELAY);
      
      // æ»¾å‹•è§¸ç™¼
      let scrollTimeout;
      window.addEventListener('scroll', function() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(checkScrollTrigger, 100);
      }, { passive: true });
      
      // é€€å‡ºæ„åœ–è§¸ç™¼ï¼ˆåƒ…æ¡Œé¢ç‰ˆï¼‰
      if (window.innerWidth > 768) {
        setTimeout(() => {
          document.addEventListener('mouseout', detectExitIntent);
        }, 10000); // 10ç§’å¾Œé–‹å§‹ç›£è½é€€å‡ºæ„åœ–
      }
    }
  }
  
  // DOM è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>