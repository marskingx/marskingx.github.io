<!-- Breadcrumb JSON-LD -->
{{/* Build breadcrumb items as proper data and emit via jsonify to avoid double-quoting */}}
{{- $items := slice -}}
{{- $home := dict "@type" "ListItem" "position" 1 "name" "首頁" "item" site.Home.Permalink -}}
{{- $items = $items | append $home -}}

{{- if and .Params.categories (gt (len .Params.categories) 0) -}}
  {{- $catName := (index .Params.categories 0 | humanize) -}}
  {{- $catURL := printf "%s%s/" ("categories/" | relLangURL) (index .Params.categories 0 | urlize | lower) | absURL -}}
  {{- $cat := dict "@type" "ListItem" "position" 2 "name" $catName "item" $catURL -}}
  {{- $items = $items | append $cat -}}
{{- end -}}

{{- if .Section -}}
  {{- $pos := cond (and .Params.categories (gt (len .Params.categories) 0)) 3 2 -}}
  {{- $secName := (.Section | humanize) -}}
  {{- $secURL := printf "/%s/" .Section | absURL -}}
  {{- $sec := dict "@type" "ListItem" "position" $pos "name" $secName "item" $secURL -}}
  {{- $items = $items | append $sec -}}
{{- end -}}

{{- $finalPos := 2 -}}
{{- if and (and .Params.categories (gt (len .Params.categories) 0)) .Section -}}
  {{- $finalPos = 4 -}}
{{- else if or (and .Params.categories (gt (len .Params.categories) 0)) .Section -}}
  {{- $finalPos = 3 -}}
{{- end -}}
{{- $currentName := (.Title | default (path.Base .Permalink | humanize)) -}}
{{- $current := dict "@type" "ListItem" "position" $finalPos "name" $currentName "item" .Permalink -}}
{{- $items = $items | append $current -}}

<script type="application/ld+json">
  {{- dict 
    "@context" "https://schema.org"
    "@type" "BreadcrumbList"
    "itemListElement" $items
    | jsonify (dict "indent" "  ") 
    | safeJS -}}
</script>
