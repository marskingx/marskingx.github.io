{{/* è‡ªå‹•ç‚ºæ–‡ç« é é¢ç”¢ç”Ÿ BlogPosting çµæ§‹åŒ–è³‡æ–™ã€‚
  å¦‚æœæ–‡ç« åˆ†é¡ç‚º "é–±è®€å¿ƒå¾—" ä¸”åŒ…å« `rate` åƒæ•¸ï¼Œå‰‡æœƒè‡ªå‹•è¿½åŠ  Review (æ˜Ÿç´šè©•åˆ†) è³‡è¨Šã€‚
*/}}
{{ if and .IsPage (eq .Section "blog") }}
  {{/* Create a scratchpad for the schema */}}
  {{ $schema := newScratch }}

  {{/* Base BlogPosting Schema */}}
  {{ $schemaData := dict "@context" "https://schema.org" "@type" "BlogPosting" }}
  {{ $schemaData = merge $schemaData (dict "mainEntityOfPage" (dict "@type" "WebPage" "@id" .Permalink)) }}
{{/* Robust headline fallback to avoid empty titles */}}
{{ $pageTitle := .Title | default .Params.title | default .Params.seo_title | default (path.Base .Permalink | humanize) }}
{{ $schemaData = merge $schemaData (dict "headline" $pageTitle) }}
  {{ $schemaData = merge $schemaData (dict "description" (.Description | default .Summary)) }}

  {{/* Image */}}
  {{ with .Params.image }}
    {{ $imageURL := . | absURL }}
    {{ $schemaData = merge $schemaData (dict "image" (dict "@type" "ImageObject" "url" $imageURL)) }}
  {{ end }}

  {{/* Author - ONLY if author param exists and is not empty */}}
  {{ with .Params.author }}
    {{ if ne . "" }}
      {{ $authorData := dict "@type" "Person" "name" . }}
      {{ $authorData = merge $authorData (dict "@id" (printf "%s#founder" site.BaseURL)) }}
      {{ $authorData = merge $authorData (dict "url" (printf "%s%s/" ("authors/" | relLangURL) (. | urlize))) }}
      {{ $schemaData = merge $schemaData (dict "author" $authorData) }}
    {{ end }}
  {{ end }}

  {{/* Publisher */}}
  {{ $logoURL := site.Params.logo | default "/favicon.png" | absURL }}
  {{ $publisher := dict "@type" "Organization" "name" site.Title }}
  {{ $publisher = merge $publisher (dict "@id" (printf "%s#organization" site.BaseURL)) }}
  {{ $publisher = merge $publisher (dict "logo" (dict "@type" "ImageObject" "url" $logoURL)) }}
  {{ $schemaData = merge $schemaData (dict "publisher" $publisher) }}

  {{/* Dates */}}
  {{ $schemaData = merge $schemaData (dict "datePublished" (.PublishDate.Format "2006-01-02T15:04:05Z07:00")) }}
  {{ $schemaData = merge $schemaData (dict "dateModified" (.Lastmod.Format "2006-01-02T15:04:05Z07:00")) }}

  {{/* Categories & Tags as keywords */}}
  {{ $keywords := slice }}
  {{ with .Params.categories }}
    {{ $keywords = $keywords | append . }}
  {{ end }}
  {{ with .Params.tags }}
    {{ $keywords = $keywords | append . }}
  {{ end }}
  {{ if $keywords }}
    {{ $schemaData = merge $schemaData (dict "keywords" (delimit ($keywords | uniq) ", ")) }}
  {{ end }}

  {{/* Article Section - Only if categories exist */}}
  {{ with index .Params.categories 0 }}
    {{ $schemaData = merge $schemaData (dict "articleSection" .) }}
  {{ end }}

  {{/* Word Count and Language */}}
  {{ $schemaData = merge $schemaData (dict "wordCount" .WordCount) }}
  {{ $schemaData = merge $schemaData (dict "inLanguage" site.Language.Lang) }}
  {{ $schemaData = merge $schemaData (dict "url" .Permalink) }}

  {{/* ğŸ”¥ CTR å„ªåŒ–ï¼šæ™ºæ…§åˆ¤æ–·æ›¸è©•ä¸¦ç”Ÿæˆç¨ç«‹ Review + æ•´åˆ BlogPosting */}}
  {{ if and (in .Params.categories "é–±è®€å¿ƒå¾—") .Params.rate }}
    {{/* è¨ˆç®—æ˜Ÿç´šè©•åˆ†ï¼šè¨ˆç®— â­ ç¬¦è™Ÿçš„æ•¸é‡ */}}
    {{ $ratingValue := 0 }}
    {{ $rateStr := .Params.rate | string }}
    {{ range split $rateStr "" }}
      {{ if eq . "â­" }}
        {{ $ratingValue = add $ratingValue 1 }}
      {{ end }}
    {{ end }}

    {{/* å¦‚æœæˆåŠŸè§£æåˆ°è©•åˆ†ï¼Œå‰µå»ºå®Œæ•´çš„ Review çµæ§‹åŒ–è³‡æ–™ */}}
    {{ if gt $ratingValue 0 }}
      {{/* æå–æ›¸åï¼šå¾æ¨™é¡Œä¸­å–å¾—æ›¸åï¼ˆå»é™¤ã€æ›¸å–®ã€‘å‰ç¶´ï¼‰ */}}
      {{ $bookTitle := .Title }}
      {{ $bookTitle = $bookTitle | replaceRE "^ã€[^ã€‘]*ã€‘\\s*" "" }}
      {{ $bookTitle = $bookTitle | replaceRE "\\s*é–±è®€å¿ƒå¾—\\s*$" "" }}

      {{/* å»ºç«‹ç¨ç«‹çš„ Review çµæ§‹åŒ–è³‡æ–™ */}}
      {{ $reviewData := dict "@type" "Review" }}
      {{ $reviewData = merge $reviewData (dict "itemReviewed" (dict "@type" "Book" "name" $bookTitle)) }}
      {{ $reviewData = merge $reviewData (dict "reviewRating" (dict "@type" "Rating" "ratingValue" $ratingValue "bestRating" 5 "worstRating" 1)) }}
      {{ $reviewData = merge $reviewData (dict "author" (dict "@type" "Person" "name" (.Params.author | default "æ‡¶å¤§") "@id" (printf "%s#founder" site.BaseURL))) }}
      {{ $reviewData = merge $reviewData (dict "reviewBody" (.Summary | default .Description)) }}
      {{ $reviewData = merge $reviewData (dict "datePublished" (.PublishDate.Format "2006-01-02")) }}
      {{ $reviewData = merge $reviewData (dict "headline" .Title) }}
      {{ $reviewData = merge $reviewData (dict "url" .Permalink) }}

      {{/* åœ¨ BlogPosting ä¸­ä¹Ÿæ·»åŠ  Review é—œè¯ */}}
      {{ $schemaData = merge $schemaData (dict "review" $reviewData) }}

      {{/* ğŸ¯ é—œéµå„ªåŒ–ï¼šå°‡æ–‡ç« é¡å‹æ”¹ç‚º Reviewï¼Œå¢åŠ æœå°‹å¼•æ“ç†è§£åº¦ */}}
      {{ $schemaData = merge $schemaData (dict "@type" (slice "BlogPosting" "Review")) }}
    {{ end }}
  {{ end }}

  {{/* Output JSON-LD */}}
<script type="application/ld+json">
  {{
    $schemaData
    |
    jsonify
    (dict
    "indent"
    "  "
    )
    |
    safeJS
  }}
</script>
{{ end }}
