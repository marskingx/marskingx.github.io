name: ğŸ“§ Mailchimp Newsletter

# ç•¶æœ‰æ–°çš„ commit æ¨é€åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼
on:
  push:
    branches: [ main ]
    paths:
      - 'content/**/*.md'  # åªæœ‰ç•¶ content ç›®éŒ„ä¸‹çš„ markdown æª”æ¡ˆè®Šæ›´æ™‚æ‰è§¸ç™¼

# è¨­å®šå·¥ä½œæµç¨‹æ¬Šé™
permissions:
  contents: read

jobs:
  # æª¢æ¸¬æ–°æ–‡ç« ä¸¦ç™¼é€é›»å­å ±
  newsletter-notification:
    runs-on: ubuntu-latest
    
    steps:
    # ç¬¬ä¸€æ­¥ï¼šæª¢å‡ºä»£ç¢¼åº«
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # éœ€è¦ç²å–å‰å…©å€‹ commit ä¾†æ¯”è¼ƒè®Šæ›´
    
    # ç¬¬äºŒæ­¥ï¼šè¨­å®š Node.js ç’°å¢ƒ
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    # ç¬¬ä¸‰æ­¥ï¼šå®‰è£ç›¸ä¾å¥—ä»¶
    - name: Install dependencies
      run: |
        npm install axios yaml front-matter
    
    # ç¬¬å››æ­¥ï¼šDebug ç’°å¢ƒå’Œ API é€£ç·š
    - name: Debug Mailchimp environment
      env:
        MAILCHIMP_API_KEY: ${{ secrets.MAILCHIMP_API_KEY }}
        MAILCHIMP_SERVER_PREFIX: ${{ secrets.MAILCHIMP_SERVER_PREFIX }}
        MAILCHIMP_AUDIENCE_ID: ${{ secrets.MAILCHIMP_AUDIENCE_ID }}
        SITE_BASE_URL: ${{ secrets.SITE_BASE_URL }}
      run: |
        node .github/scripts/debug-mailchimp.js
    
    # ç¬¬äº”æ­¥ï¼šåŸ·è¡Œæ–°æ–‡ç« æª¢æ¸¬å’Œé€šçŸ¥è…³æœ¬
    - name: Check for new articles and send notifications
      env:
        MAILCHIMP_API_KEY: ${{ secrets.MAILCHIMP_API_KEY }}
        MAILCHIMP_SERVER_PREFIX: ${{ secrets.MAILCHIMP_SERVER_PREFIX }}
        MAILCHIMP_AUDIENCE_ID: ${{ secrets.MAILCHIMP_AUDIENCE_ID }}
        SITE_BASE_URL: ${{ secrets.SITE_BASE_URL }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        node .github/scripts/mailchimp-notifier.js
    
    # ç¬¬äº”æ­¥ï¼šç´€éŒ„åŸ·è¡Œçµæœï¼ˆæˆåŠŸæˆ–å¤±æ•—éƒ½æœƒåŸ·è¡Œï¼‰
    - name: Log execution result
      if: always()
      run: |
        echo "å·¥ä½œæµç¨‹åŸ·è¡Œå®Œæˆ"
        echo "æ™‚é–“: $(date)"
        echo "Commit SHA: ${{ github.sha }}"
        echo "è§¸ç™¼äº‹ä»¶: ${{ github.event_name }}"